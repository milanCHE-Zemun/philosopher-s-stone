<!Doctype HTML>

<html ng-app="littleToDoApp">

<head>
     <title>Tasks App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css?family=Alegreya" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Mukta+Mahee" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Itim", rel="stylesheet">
    
    <style>
        body {
            background-color: whitesmoke;
            padding: 10px;
        }
        div.to_do {
            display: grid;
            grid-template-rows: 1fr 1fr auto 1fr 1fr;
            grid-template-columns: 1fr 3.6fr 3.6fr 1.8fr;
        }
        div#toolbar {
            grid-row: 2;
            grid-column: 2 / 4;
            background-color: teal;
        }
        div#tasks_at_hand {
            grid-column: 3;
            grid-row: 3;
        }
        div#app_name {
            float: left;
            height: 100%;
            color: whitesmoke;
            font-family: 'Mukta Mahee', sans-serif;
            font-size: 28px;
        }
        div#active_tasks_label {
            font-family: 'Mukta Mahee', sans-serif;
            font-size: 26px;
            float: right;
            width: 25%;
            height: 100%;
            color: whitesmoke;
        }
        div#task_list_complete {
            width: 50%;
            float: right;
        }
        div#task_list_active {
            width: 50%;
            float: left;
        }
        div#completed_tasks_label {
            font-family: 'Mukta Mahee', sans-serif;
            font-size: 26px;
            float: right;
            width: 25%;
            height: 100%;
            color: whitesmoke;
        }
        div#new_task {
            grid-row: 3;
            grid-column: 2;
        }
        button.new_task_btn {
            width: 60px;
            height: 50px;
            border-radius: 10%;
            border: 2px groove black;
            box-sizing: border-box;
            font: bold normal 42px/48px Gothic, serif;
        }
        input#new_task_inpt {
            width: 300px;
            height: 44px;
            border: 2px solid #000;
            border-radius: 5%;
            background-color: white;
            font: bold normal 38px/36px Georgia, serif;
        }
        span.completed_tasks_txt, span.active_tasks_txt {
            font-family: 'Oswald', sans-serif;
            font-size: 28px;
        }
        span.completed_tasks_txt {
            text-decoration: line-through;
            opacity: 0.8;
        }
        #clear {
            clear: both;
        }
    </style>

</head>
<body ng-controller="ToDoController">
    <div class="to_do">
        <div id="toolbar">
            <div id="app_name">
                <h3>Little TO-DO Application</h3>
            </div>
            <div id="completed_tasks_label">
                 <h3>Completed tasks ({{ completed.length }})</h3>
            </div> 
            <div id="active_tasks_label">
                <h3>Active tasks ({{ tasks.length }})</h3>
            </div>
        </div>
        
        <div id="tasks_at_hand">
            <div id="task_list_complete">
                <div ng-show="completed.length">
                    <div ng-repeat="task in completed">
                        <input class="tasks_completed_checked" type="checkbox" ng-click="change($index, completed, tasks)" checked />
                            <span class="completed_tasks_txt">{{ task }}</span><br />
                    </div>
                </div>
            </div>
        
            <div id="task_list_active">
                <span ng-hide="tasks.length" style="font: bold italic 22px/24px Gothic, serif">The are no tasks at the moment</span>
                    <div ng-repeat="task in tasks">
                        <input type="checkbox" class="tasks_active_checked" ng-click="change($index, tasks, completed)" />
                            <span class="active_tasks_txt">{{ task }}</span> <br />
                    </div>
            </div>
        </div>
        <div id="new_task">
            <form id="task_form">
                <div style="display:inline-block;margin: auto;vertical-align:middle;">
                <input id="new_task_inpt" inpt type="text" name="new_task" ng-model="newtask" placeholder="Add new task">
                </div>
                <div style="display:inline-block;margin:auto;vertical-align:middle;">
                <button class="new_task_btn" type="submit" ng-click="add_task($event)">+</button>
                </div>
            </form>
            <span ng-show="error" style="width: 100%;font: bold normal 32px/28px Gothic, serif; color:red;">{{ error }}</span>
        </div>
    </div>
<div id="clear"></div>  
    
    <script>
        angular.module('littleToDoApp', [])
            .factory('toDoService', function($interval) {
                var seen = {"Do Math" : true, "Do Your Homework" : true}
            //Data from server --simulation
                //Couple of starting tasks
                var tasks = ["Do Math", "Do Your Homework"]
                //Data from database
                var random_tasks = ["Do the dishes", "Wash hands", "Go play", "Do Math", "Buy Juice", "Do Your Homework", "Wash hands", "Clean yard", "clean yard", "Wash laundry", "Buy Juice"]
                var index = 0

                return {
                    setTasks : function(value) {
                        tasks = value
                    },
                    getTasks : function() {
                        return tasks
                    },
                    addTask : function(task_name, callback) {
                        for (var prop in seen) {
                            if (prop.toLowerCase() == task_name.toLowerCase()) {
                                return callback(new Error('You already have this task'))
                            } 
                        }
                        if (task_name) tasks.push(task_name)
                        return callback(null, tasks)
                    },
                    change : function(index, start, end) {
                        end.push(start[index])
                        start.splice(index, 1)
                    },
                    add_random_tasks : function(callback) {
                    //Brute force
                    //Try another aproach
                        var new_arr = []

                        for (var i = 0; i < random_tasks.length;i ++) {
                            if (!(random_tasks[i] in seen)) {
                                seen[random_tasks[i]] = true
                                new_arr.push(random_tasks[i])            
                            }
                        }

                        var si = $interval(function() {
                            if (index == new_arr.length - 1) {                             
                                $interval.cancel(si)
                            } 
                               callback(tasks)
                                tasks.push(new_arr[index])
                                 index ++
                            }, 1000) //changing to 30000                                   
                    }
                }
            })
        .controller("ToDoController", ["$scope", "toDoService", function($scope, toDoService) {
            
            $scope.$watch(function() {
                return toDoService.getTasks()
            }, function(nv, ov) {
                if (nv != null) $scope.tasks = nv
            })

            $scope.error = null
            
            toDoService.add_random_tasks(function(t) {
                $scope.tasks = t
            })
            
            $scope.completed = []
            $scope.taskname = ''

            $scope.change = function(index, start, end) {
                return toDoService.change(index, start, end)
            }
            
            $scope.add_task = function(evt) {
                toDoService.addTask($scope.newtask, function(err, t) {
                    if (!err) { 
                        $scope.newtask = ''
                        $scope.tasks = t
                    } else {
                        $scope.error = err.message
                        return false
                    }
                })
            }
        }])
        .directive('inpt', function() {
            return {
                restrict : 'AE',
                link : function(scope, element, attrs) {
                    var str_arr = []
                    var str = ''
                    element.bind('keyup', function(e) {
                        str = e.target.value
                        if (!scope.validate_string(str)) {
                            scope.error = 'Bad input. Use capital letter for start'
                            scope.newtask = ''
                        } else {
                            scope.error = null
                        }
                    })
                },
                controller : function($scope) {
                    $scope.validate_string = function(str) {
                        var regex = /[A-Z][a-z0-9!#$%^&!]*[a-z0-9!#$%^&\s]*/g
                        return str.match(regex) ? true : false
                    }
                }
            }    
        })

    </script>

</body>
  
</html>